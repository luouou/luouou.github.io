<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Mist","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="下载地址 Boot Loader系统在上电或复位时通常都从地址0x00000000处开始执行，而在这个地址处安排的通常就是系统的Boot Loader程序。 Boot Loader (引导加载程序)就是在操作系统内核运行之前运行的一段小程序。通过这段代码实现硬件的初始化，建立内存空间的映射，为操作系统内核准备好硬件环境并引导内核的启动。 Boot Loader的主要运行任务就是将内核镜像从硬盘(N">
<meta property="og:type" content="article">
<meta property="og:title" content="uboot">
<meta property="og:url" content="http://example.com/2022/09/04/boot/uboot/index.html">
<meta property="og:site_name" content="nullptr">
<meta property="og:description" content="下载地址 Boot Loader系统在上电或复位时通常都从地址0x00000000处开始执行，而在这个地址处安排的通常就是系统的Boot Loader程序。 Boot Loader (引导加载程序)就是在操作系统内核运行之前运行的一段小程序。通过这段代码实现硬件的初始化，建立内存空间的映射，为操作系统内核准备好硬件环境并引导内核的启动。 Boot Loader的主要运行任务就是将内核镜像从硬盘(N">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/uboot/uboot_arch.png">
<meta property="og:image" content="http://example.com/images/uboot/uboot_mem.png">
<meta property="og:image" content="http://example.com/images/uboot/vmlinux.bmp">
<meta property="article:published_time" content="2022-09-04T12:23:47.289Z">
<meta property="article:modified_time" content="2022-09-04T12:23:47.289Z">
<meta property="article:author" content="ubun2">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/uboot/uboot_arch.png">

<link rel="canonical" href="http://example.com/2022/09/04/boot/uboot/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>uboot | nullptr</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">nullptr</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">吾生也有涯 而知也无涯</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/04/boot/uboot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ubun2">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nullptr">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          uboot
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-04 20:23:47" itemprop="dateCreated datePublished" datetime="2022-09-04T20:23:47+08:00">2022-09-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/uboot/" itemprop="url" rel="index"><span itemprop="name">uboot</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><a target="_blank" rel="noopener" href="https://ftp.denx.de/pub/u-boot/">下载地址</a></p>
<h2 id="Boot-Loader"><a href="#Boot-Loader" class="headerlink" title="Boot Loader"></a>Boot Loader</h2><p>系统在上电或复位时通常都从地址0x00000000处开始执行，而在这个地址处安排的通常就是系统的Boot Loader程序。</p>
<p>Boot Loader (引导加载程序)就是在操作系统内核运行之前运行的一段小程序。通过这段代码<br>实现硬件的初始化，建立内存空间的映射，为操作系统内核准备好硬件环境并引导内核的启动。</p>
<p>Boot Loader的主要运行任务就是将内核镜像从硬盘(NAND flash or eMMC)上读到RAM中，然后跳转到内核的入口点去运行，即开始启动操作系统。Bootloader的启动过程可以分为单阶段(Single Stage)、多阶段(Multi-Stage)两种。</p>
<p>u-boot是一种通用的用于嵌入式系统的Bootloader，同时支持 ARM 体系结构和 MIPS 体系结构。uboot必须要具备的能力：</p>
<ol>
<li>能自身开机直接启动，必须进行和硬件相对应的代码级别的更改和移植，才能够保证可以从相应的启动介质启动。</li>
<li>能引导操作系统内核启动并给内核传参，uboot 的终极目标就是启动内核，参数通过环境变量设置。</li>
<li>能进行 SoC 级和板级硬件管理，控制部分硬件外设。</li>
<li>能提供系统部署功能，实现flash上的烧录下载。</li>
</ol>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p><img src="/images/uboot/uboot_arch.png" alt="img"></p>
<p>u-boot-2010.06及以后版本目录结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">├── api                存放uboot提供的接口函数</span><br><span class="line">├── arch               CPU体系结构相关的代码，每种架构对应一个子目录</span><br><span class="line">├── board              开发板相关的文件，每种开发板对应一个子目录</span><br><span class="line">├── common             通用的代码，主要实现 uboot命令行下支持的命令，每一条命令对应一个文件。</span><br><span class="line">├── disk               磁盘分区相关代码</span><br><span class="line">├── doc                文档</span><br><span class="line">├── drivers            支持的设备驱动</span><br><span class="line">├── examples           示例程序</span><br><span class="line">├── fs                 文件系统，目前支持 cramfs、fat、fdos、jffs2 和 registerfs</span><br><span class="line">├── include            头文件，已通用的头文件为主</span><br><span class="line">├── lib                通用库文件</span><br><span class="line">├── nand_spl           NAND存储器相关代码</span><br><span class="line">├── net                网络相关代码，小型的协议栈</span><br><span class="line">├── onenand_ipl</span><br><span class="line">├── post               加电自检程序</span><br><span class="line">└── tools              辅助程序，用于编译和检查uboot目标文件</span><br></pre></td></tr></table></figure>

<h2 id="编译与配置"><a href="#编译与配置" class="headerlink" title="编译与配置"></a>编译与配置</h2><h3 id="Makefile-分析"><a href="#Makefile-分析" class="headerlink" title="Makefile 分析"></a>Makefile 分析</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">VERSION = 2013    <span class="comment">#主版本号</span></span><br><span class="line">PATCHLEVEL = 10   <span class="comment">#次版本号</span></span><br><span class="line">SUBLEVEL =        <span class="comment">#子版本号</span></span><br><span class="line">EXTRAVERSION =    <span class="comment">#附加的版本信息</span></span><br><span class="line"><span class="keyword">ifneq</span> <span class="string">&quot;<span class="variable">$(SUBLEVEL)</span>&quot;</span> <span class="string">&quot;&quot;</span></span><br><span class="line">U_BOOT_VERSION = <span class="variable">$(VERSION)</span>.<span class="variable">$(PATCHLEVEL)</span>.<span class="variable">$(SUBLEVEL)</span><span class="variable">$(EXTRAVERSION)</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">U_BOOT_VERSION = <span class="variable">$(VERSION)</span>.<span class="variable">$(PATCHLEVEL)</span><span class="variable">$(EXTRAVERSION)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line">TIMESTAMP_FILE = <span class="variable">$(obj)</span><span class="keyword">include</span>/generated/timestamp_autogenerated.h</span><br><span class="line">VERSION_FILE = <span class="variable">$(obj)</span><span class="keyword">include</span>/generated/version_autogenerated.h</span><br><span class="line"></span><br><span class="line"><span class="keyword">ifeq</span> (,<span class="variable">$(<span class="built_in">findstring</span> s,<span class="variable">$(MAKEFLAGS)</span>)</span>)</span><br><span class="line">XECHO = echo</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">XECHO = :</span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<p>uboot编译时，会将版本信息输出到 include\generated\version_autogenerated.h 文件中。<code>make -s</code> 可以使 XECHO 变量为空，关闭编译信息打印。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">MKCONFIG := <span class="variable">$(SRCTREE)</span>/mkconfig</span><br><span class="line"><span class="keyword">export</span> MKCONFIG</span><br><span class="line"></span><br><span class="line"><span class="section">unconfig:</span></span><br><span class="line">    @rm -f <span class="variable">$(obj)</span><span class="keyword">include</span>/config.h <span class="variable">$(obj)</span><span class="keyword">include</span>/config.mk \</span><br><span class="line">        <span class="variable">$(obj)</span>board/*/config.tmp <span class="variable">$(obj)</span>board/*/*/config.tmp \</span><br><span class="line">        <span class="variable">$(obj)</span><span class="keyword">include</span>/autoconf.mk <span class="variable">$(obj)</span><span class="keyword">include</span>/autoconf.mk.dep \</span><br><span class="line">        <span class="variable">$(obj)</span><span class="keyword">include</span>/spl-autoconf.mk \</span><br><span class="line">        <span class="variable">$(obj)</span><span class="keyword">include</span>/tpl-autoconf.mk</span><br><span class="line">        </span><br><span class="line"><span class="section">%_config:: unconfig</span></span><br><span class="line">    @<span class="variable">$(MKCONFIG)</span> -A $(@:_config=)</span><br></pre></td></tr></table></figure>

<p>设置[mkconfig](#mkconfig 分析)脚本的路径。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">all:</span></span><br><span class="line"><span class="keyword">sinclude</span> <span class="variable">$(obj)</span><span class="keyword">include</span>/autoconf.mk.dep</span><br><span class="line"><span class="keyword">sinclude</span> <span class="variable">$(obj)</span><span class="keyword">include</span>/autoconf.mk</span><br></pre></td></tr></table></figure>

<p>导入include/autoconf.mk文件，由配置脚本根据inlcude/configs/xxx.h 头文件生成的，里面包含与开发板相关的配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_SYS_TEXT_BASE=0x34800000</span><br><span class="line">CONFIG_COMMON_BOOT=&quot;&quot;console=ttySAC0,115200n8 mem=128M  &quot; MTDPARTS_DEFAULT&quot;</span><br><span class="line">CONFIG_BOOTARGS=&quot;&quot;root=/dev/mtdblock5 ubi.mtd=4 rootfstype=cramfs &quot; CONFIG_COMMON_BOOT&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="variable">$(obj)</span><span class="keyword">include</span>/config.mk</span><br><span class="line"><span class="keyword">export</span> ARCH CPU BOARD VENDOR SOC</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(TOPDIR)</span>/config.mk</span><br></pre></td></tr></table></figure>

<p>导入include/config.mk文件，里面包含ARCH, BOARD, VENDOR, SOC 和 CPU 变量，这是配置过程自动生成的。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ARCH   = arm</span><br><span class="line">CPU    = armv7</span><br><span class="line">BOARD  = smdkc100</span><br><span class="line">VENDOR = samsung</span><br><span class="line">SOC    = s5pc1xx</span><br></pre></td></tr></table></figure>

<p>导入config.mk文件，里面定义编译工具配置项。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CC = <span class="variable">$(CROSS_COMPILE)</span>gcc</span><br><span class="line">CPP = <span class="variable">$(CC)</span> -E</span><br><span class="line">AR = <span class="variable">$(CROSS_COMPILE)</span>ar</span><br><span class="line">NM = <span class="variable">$(CROSS_COMPILE)</span>nm</span><br><span class="line">LDR = <span class="variable">$(CROSS_COMPILE)</span>ldr</span><br><span class="line">STRIP = <span class="variable">$(CROSS_COMPILE)</span>strip</span><br><span class="line">OBJCOPY = <span class="variable">$(CROSS_COMPILE)</span>objcopy</span><br><span class="line">OBJDUMP = <span class="variable">$(CROSS_COMPILE)</span>objdump</span><br><span class="line">RANLIB = <span class="variable">$(CROSS_COMPILE)</span>RANLIB</span><br><span class="line"></span><br><span class="line">LDFLAGS_u-boot += -T <span class="variable">$(obj)</span>u-boot.lds <span class="variable">$(LDFLAGS_FINAL)</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(CONFIG_SYS_TEXT_BASE)</span>,)</span><br><span class="line">LDFLAGS_u-boot += -Ttext <span class="variable">$(CONFIG_SYS_TEXT_BASE)</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<p><code>-Ttext</code>用 来指定uboot的链接起始地址，链接脚本也可以指定，但最终以这个为准。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ifndef</span> LDSCRIPT</span><br><span class="line">    <span class="keyword">ifeq</span> (<span class="variable">$(CONFIG_NAND_U_BOOT)</span>,y)</span><br><span class="line">        LDSCRIPT := <span class="variable">$(TOPDIR)</span>/board/<span class="variable">$(BOARDDIR)</span>/u-boot-nand.lds</span><br><span class="line">        <span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">wildcard</span> <span class="variable">$(LDSCRIPT)</span>)</span>,)</span><br><span class="line">            LDSCRIPT := <span class="variable">$(TOPDIR)</span>/<span class="variable">$(CPUDIR)</span>/u-boot-nand.lds</span><br><span class="line">        <span class="keyword">endif</span></span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line">    <span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">wildcard</span> <span class="variable">$(LDSCRIPT)</span>)</span>,)</span><br><span class="line">        LDSCRIPT := <span class="variable">$(TOPDIR)</span>/board/<span class="variable">$(BOARDDIR)</span>/u-boot.lds</span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line">    <span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">wildcard</span> <span class="variable">$(LDSCRIPT)</span>)</span>,)</span><br><span class="line">        LDSCRIPT := <span class="variable">$(TOPDIR)</span>/<span class="variable">$(CPUDIR)</span>/u-boot.lds</span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line">    <span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">wildcard</span> <span class="variable">$(LDSCRIPT)</span>)</span>,)</span><br><span class="line">        LDSCRIPT := <span class="variable">$(TOPDIR)</span>/arch/<span class="variable">$(ARCH)</span>/cpu/u-boot.lds</span><br><span class="line">        <span class="comment"># We don&#x27;t expect a Makefile here</span></span><br><span class="line">        LDSCRIPT_MAKEFILE_DIR =</span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line">    <span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">wildcard</span> <span class="variable">$(LDSCRIPT)</span>)</span>,)</span><br><span class="line"><span class="variable">$(<span class="built_in">error</span> could not find linker script)</span></span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<p>指定链接脚本，如果定义了 CONFIG_NAND_U_BOOT 宏，则链接脚本叫 u-boot-nand.lds，如果未定义这个宏则链接脚本叫 u-boot.lds。查找顺序为 board/, cpu_xxx/, arch/。</p>
<h3 id="mkconfig-分析"><a href="#mkconfig-分析" class="headerlink" title="mkconfig 分析"></a>mkconfig 分析</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">if [ \( $# -eq 2 \) -a \( &quot;$1&quot; = &quot;-A&quot; \) ] ; then</span><br><span class="line">    # Automatic mode</span><br><span class="line">    line=`awk &#x27;($0 !~ /^#/ &amp;&amp; $7 ~ /^&#x27;&quot;$2&quot;&#x27;$/) &#123; print $1, $2, $3, $4, $5, $6, $7, $8 &#125;&#x27; boards.cfg`</span><br><span class="line">    if [ -z &quot;$line&quot; ] ; then</span><br><span class="line">        echo &quot;make: *** No rule to make target \`$2_config&#x27;.  Stop.&quot; &gt;&amp;2</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    set $&#123;line&#125;</span><br><span class="line">    # add default board name if needed</span><br><span class="line">    [ $# = 3 ] &amp;&amp; set $&#123;line&#125; $&#123;1&#125;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>boards.cfg 文件定义了一张 board 与arch, cpu, soc, vendor 对应的表。通过解析 boards.cfg 文件可获得相应的信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Active  arm         armv7          s5pc1xx     samsung         smdkc100            smdkc100                                                </span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">if [ &quot;$SRCTREE&quot; != &quot;$OBJTREE&quot; ] ; then</span><br><span class="line">    mkdir -p $&#123;OBJTREE&#125;/include</span><br><span class="line">    mkdir -p $&#123;OBJTREE&#125;/include2</span><br><span class="line">    cd $&#123;OBJTREE&#125;/include2</span><br><span class="line">    rm -f asm</span><br><span class="line">    ln -s $&#123;SRCTREE&#125;/arch/$&#123;arch&#125;/include/asm asm</span><br><span class="line">    LNPREFIX=$&#123;SRCTREE&#125;/arch/$&#123;arch&#125;/include/asm/</span><br><span class="line">    cd ../include</span><br><span class="line">    mkdir -p asm</span><br><span class="line">else</span><br><span class="line">    cd ./include</span><br><span class="line">    rm -f asm</span><br><span class="line">    ln -s ../arch/$&#123;arch&#125;/include/asm asm</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">rm -f asm/arch</span><br><span class="line"></span><br><span class="line">if [ -z &quot;$&#123;soc&#125;&quot; ] ; then</span><br><span class="line">    ln -s $&#123;LNPREFIX&#125;arch-$&#123;cpu&#125; asm/arch</span><br><span class="line">else</span><br><span class="line">    ln -s $&#123;LNPREFIX&#125;arch-$&#123;soc&#125; asm/arch</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ &quot;$&#123;arch&#125;&quot; = &quot;arm&quot; ] ; then</span><br><span class="line">    rm -f asm/proc</span><br><span class="line">    ln -s $&#123;LNPREFIX&#125;proc-armv asm/proc</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>创建 asm, arch, proc 3个指向具体平台的软连接。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">( echo &quot;ARCH   = $&#123;arch&#125;&quot;</span><br><span class="line">    if [ ! -z &quot;$spl_cpu&quot; ] ; then</span><br><span class="line">    echo &#x27;ifeq ($(CONFIG_SPL_BUILD),y)&#x27;</span><br><span class="line">    echo &quot;CPU    = $&#123;spl_cpu&#125;&quot;</span><br><span class="line">    echo &quot;else&quot;</span><br><span class="line">    echo &quot;CPU    = $&#123;cpu&#125;&quot;</span><br><span class="line">    echo &quot;endif&quot;</span><br><span class="line">    else</span><br><span class="line">    echo &quot;CPU    = $&#123;cpu&#125;&quot;</span><br><span class="line">    fi</span><br><span class="line">    echo &quot;BOARD  = $&#123;board&#125;&quot;</span><br><span class="line"></span><br><span class="line">    [ &quot;$&#123;vendor&#125;&quot; ] &amp;&amp; echo &quot;VENDOR = $&#123;vendor&#125;&quot;</span><br><span class="line">    [ &quot;$&#123;soc&#125;&quot;    ] &amp;&amp; echo &quot;SOC    = $&#123;soc&#125;&quot;</span><br><span class="line">    exit 0 ) &gt; config.mk</span><br></pre></td></tr></table></figure>

<p>创建 include/config.mk 文件，被主 Makefile 包含。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;/* Automatically generated - do not edit */&quot; &gt;&gt;config.h</span><br><span class="line"></span><br><span class="line">for i in $&#123;TARGETS&#125; ; do</span><br><span class="line">    i=&quot;`echo $&#123;i&#125; | sed &#x27;/=/ &#123;s/=/	/;q; &#125; ; &#123; s/$/	1/; &#125;&#x27;`&quot;</span><br><span class="line">    echo &quot;#define CONFIG_$&#123;i&#125;&quot; &gt;&gt;config.h ;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo &quot;#define CONFIG_SYS_ARCH  \&quot;$&#123;arch&#125;\&quot;&quot;  &gt;&gt; config.h</span><br><span class="line">echo &quot;#define CONFIG_SYS_CPU   \&quot;$&#123;cpu&#125;\&quot;&quot;   &gt;&gt; config.h</span><br><span class="line">echo &quot;#define CONFIG_SYS_BOARD \&quot;$&#123;board&#125;\&quot;&quot; &gt;&gt; config.h</span><br><span class="line"></span><br><span class="line">[ &quot;$&#123;vendor&#125;&quot; ] &amp;&amp; echo &quot;#define CONFIG_SYS_VENDOR \&quot;$&#123;vendor&#125;\&quot;&quot; &gt;&gt; config.h</span><br><span class="line"></span><br><span class="line">[ &quot;$&#123;soc&#125;&quot;    ] &amp;&amp; echo &quot;#define CONFIG_SYS_SOC    \&quot;$&#123;soc&#125;\&quot;&quot;    &gt;&gt; config.h</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt;&gt; config.h</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">define CONFIG_BOARDDIR board/<span class="variable">$BOARDDIR</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;config_cmd_defaults.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;config_defaults.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;configs/<span class="variable">$&#123;CONFIG_NAME&#125;</span>.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;asm/config.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;config_fallbacks.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;config_uncmd_spl.h&gt;</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>创建或追加(make -a) include/config.h 头文件，这个文件会被大部分c文件包含。</p>
<h3 id="u-boot-lds"><a href="#u-boot-lds" class="headerlink" title="u-boot.lds"></a>u-boot.lds</h3><p>arch/arm/cpu/u-boot.lds 是ld连接器的脚本文件，描述如何连接目标文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">/* 指定输出可执行文件是 elf 格式,32 位 ARM 指令,小端 */</span><br><span class="line">OUTPUT_FORMAT(&quot;elf32-littlearm&quot;, &quot;elf32-littlearm&quot;, &quot;elf32-littlearm&quot;)</span><br><span class="line"></span><br><span class="line">/* 指定输出可执行文件的平台架构为 ARM 架构 */</span><br><span class="line">OUTPUT_ARCH(arm)</span><br><span class="line"></span><br><span class="line">/* 指定程序的起始代码段为_start */</span><br><span class="line">ENTRY(_start)</span><br><span class="line"></span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">    . = 0x00000000;  @ 指定程序的链接地址</span><br><span class="line"></span><br><span class="line">    . = ALIGN(4);  @ 4字节对齐</span><br><span class="line">    .text :</span><br><span class="line">    &#123;</span><br><span class="line">        cpu/arm920t/start.o(.text)  @ 首先编译start.S</span><br><span class="line">        *(.text)  @ 所有的其他程序的代码段以4字节对齐放在它后面</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    . = ALIGN(4);</span><br><span class="line">    .rodata : &#123; *(SORT_BY_ALIGNMENT(SORT_BY_NAME(.rodata*))) &#125;</span><br><span class="line"></span><br><span class="line">    . = ALIGN(4);</span><br><span class="line">    .data : &#123; *(.data) &#125;</span><br><span class="line"></span><br><span class="line">    . = ALIGN(4);</span><br><span class="line">    .got : &#123; *(.got) &#125;</span><br><span class="line"></span><br><span class="line">    . = .;</span><br><span class="line">    __u_boot_cmd_start = .;  @ 把__u_boot_cmd_start赋值为当前位置，即起始位置</span><br><span class="line">    .u_boot_cmd : &#123; *(.u_boot_cmd) &#125;  @ 指定 u_boot_cmd段，把所有的uboot命令放在该段</span><br><span class="line">    __u_boot_cmd_end = .;  @ 把 __u_boot_cmd_end赋值为当前位置，即结束位置</span><br><span class="line"></span><br><span class="line">    . = ALIGN(4);</span><br><span class="line">    __bss_start = .;</span><br><span class="line">    .bss (NOLOAD) : &#123; *(.bss) . = ALIGN(4); &#125;</span><br><span class="line">    _end = .;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由.text段的编译顺序可知，uboot 首先运行的是 _start 符号处的代码，在 arch/arm/cpu/arm920t/<a href="#start.S">start.S</a> 文件中定义。</p>
<h2 id="启动流程分析"><a href="#启动流程分析" class="headerlink" title="启动流程分析"></a>启动流程分析</h2><p>第一阶段(stage 1)依赖于 CPU 体系结构的代码，在 SRAM 中，一般用汇编语言来实现。主要进行以下方面的设置：设置 ARM 进入 SVC 模式、禁止 IRQ 和 FIQ、关闭看门狗、屏蔽所有中断。设置CPU的速度和时钟(FCLK,HCLK,PCLK)，RAM初始化，清空 I/D cache、清空 TLB、禁止 MMU 和 cache、配置内存控制器、为搬运代码做准备、搬移 uboot 镜像到 RAM 中（使用 copy_loop 实现）、分配堆栈、清空 bss 段（使用 clbss_l 实现）。最后跳转到第二阶段。</p>
<p>主要功能为：</p>
<ul>
<li>硬件设备初始化（关闭看门狗和中断，MMU，Cache，配置系统工作时钟）。</li>
<li>为加载第二阶段代码准备RAM空间。</li>
<li>拷贝第二阶段代码到 RAM 空间中。</li>
<li>设置堆栈指针sp。</li>
<li>跳转到第二阶段代码的入口点。</li>
</ul>
<p>第二阶段(stage 2)在 DRAM 中，用c语言来实现，这样可以实现更复杂的功能，而且代码会具有更好的可读性和可移植性。初始化SoC 外部硬件(如 iNand、网卡芯片等)、 uboot 本身的一些东西(uboot 的命令、环境变量等)。</p>
<p>主要功能为：</p>
<ul>
<li>初始化本阶段要使用到的硬件设备（led uart等）。</li>
<li>检测系统内存映射(memory map)。</li>
<li>将内核镜像和根文件系统镜像从Flash上读到RAM空间中。</li>
<li>设置内核启动参数。</li>
<li>引导内核。</li>
</ul>
<h3 id="start-S"><a href="#start-S" class="headerlink" title="start.S"></a>start.S</h3><h4 id="设置异常向量表"><a href="#设置异常向量表" class="headerlink" title="设置异常向量表"></a>设置异常向量表</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.globl _start                        /* u-boot 启动入口 */</span><br><span class="line">_start: b reset                    /* 复位 */</span><br><span class="line">    ldr pc, _undefined_instruction   /* 未定义指令向量 */</span><br><span class="line">    ldr pc, _software_interrupt      /* 软件中断向量 */</span><br><span class="line">    ldr pc, _prefetch_abort          /* 预取指令异常向量 */</span><br><span class="line">    ldr pc, _data_abort              /* 数据操作异常向量 */</span><br><span class="line">    ldr pc, _not_used                /* 未使用 */</span><br><span class="line">    ldr pc, _irq                     /* irq 中断向量 */            </span><br><span class="line">    ldr pc, _fiq                     /* fiq 中断向量 */</span><br><span class="line"></span><br><span class="line">/* 中断向量表入口地址 */</span><br><span class="line">_undefined_instruction: .word undefined_instruction</span><br><span class="line">_software_interrupt:    .word software_interrupt</span><br><span class="line">_prefetch_abort:    .word prefetch_abort</span><br><span class="line">_data_abort:        .word data_abort</span><br><span class="line">_not_used:      .word not_used</span><br><span class="line">_irq:           .word irq</span><br><span class="line">_fiq:           .word fiq</span><br><span class="line"></span><br><span class="line">    .balignl 16,0xdeadbeef</span><br></pre></td></tr></table></figure>
<p>异常向量表是硬件决定的，软件只是参照硬件的设计来实现它。复位异常处的代码是<code>b reset</code>，因此在 CPU 复位后真正去执行的是<a href="#reset%E5%A4%8D%E4%BD%8D"> reset </a>符号处代码。</p>
<p><code>.balignl 16,0xdeadbeef</code>指令是让当前地址对齐排布，如果当前地址不对齐则后面的内存用 0xdeadbeef 来填充。</p>
<p>uboot编译好之后，在 uboot 目录下会生成个 System.map 文件，这里面有各个变量的值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">c3e00010 T _start</span><br><span class="line">c3e00030 t _undefined_instruction</span><br><span class="line">c3e00034 t _software_interrupt</span><br><span class="line">c3e00038 t _prefetch_abort</span><br><span class="line">c3e0003c t _data_abort</span><br><span class="line">c3e00040 t _not_used</span><br><span class="line">c3e00044 t _irq</span><br><span class="line">c3e00048 t _fiq</span><br><span class="line">c3e0004c t _pad</span><br></pre></td></tr></table></figure>

<h4 id="指定代码段的编译地址"><a href="#指定代码段的编译地址" class="headerlink" title="指定代码段的编译地址"></a>指定代码段的编译地址</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.globl _TEXT_BASE</span><br><span class="line">_TEXT_BASE:</span><br><span class="line">#if defined(CONFIG_SPL_BUILD) &amp;&amp; defined(CONFIG_SPL_TEXT_BASE)</span><br><span class="line">    .word   CONFIG_SPL_TEXT_BASE</span><br><span class="line">#else</span><br><span class="line">    .word   CONFIG_SYS_TEXT_BASE</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<p>编译器会对每一条指令分配一个编译地址，是编译器在编译过程中分配的。运行地址是指程序指令真正运行的地址，是由用户指定的。编译地址与运行地址是一一对应的。</p>
<h4 id="reset复位"><a href="#reset复位" class="headerlink" title="reset复位"></a>reset复位</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.globl	reset</span><br><span class="line">reset:</span><br><span class="line">    bl	save_boot_params</span><br><span class="line">    /*</span><br><span class="line">     * disable interrupts (FIQ and IRQ), also set the cpu to SVC32 mode,</span><br><span class="line">     * except if in HYP mode already</span><br><span class="line">     */</span><br><span class="line">    mrs	r0, cpsr</span><br><span class="line">    and	r1, r0, #0x1f		@ mask mode bits</span><br><span class="line">    teq	r1, #0x1a		@ test for HYP mode</span><br><span class="line">    bicne	r0, r0, #0x1f		@ clear all mode bits</span><br><span class="line">    orrne	r0, r0, #0x13		@ set SVC mode</span><br><span class="line">    orr	r0, r0, #0xc0		@ disable FIQ and IRQ</span><br><span class="line">    msr	cpsr,r0</span><br><span class="line"></span><br><span class="line">#ifndef CONFIG_SKIP_LOWLEVEL_INIT</span><br><span class="line">    bl	cpu_init_cp15</span><br><span class="line">    bl	cpu_init_crit</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    bl	_main</span><br><span class="line">    </span><br><span class="line">ENTRY(save_boot_params)</span><br><span class="line">    bx	lr			@ back to my caller</span><br><span class="line">ENDPROC(save_boot_params)</span><br><span class="line">    .weak	save_boot_params</span><br></pre></td></tr></table></figure>
<p>cpu设置为 SVC 模式，屏蔽 IRQ 和 FIQ 中断。跳转到[cpu_init_cp15](#cp15 协处理器初始化)处初始化协处理器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(cpu_init_crit)</span><br><span class="line">    b	lowlevel_init		@ go setup pll,mux,memory</span><br><span class="line">ENDPROC(cpu_init_crit)</span><br></pre></td></tr></table></figure>
<p>cpu_init_crit 实现cpu核心初始化，主要由 lowlevel_init 完成，代码位于 board 目录下相应 <a href="#lowlevel_init.S">lowlevel_init.S </a>文件中。</p>
<p>复位成功后程序跳转到_main符号处执行，代码位于arch/arm/lib/目录下的 <a href="#crt0.S">crt0.S</a> 文件中。</p>
<h4 id="cp15-协处理器初始化"><a href="#cp15-协处理器初始化" class="headerlink" title="cp15 协处理器初始化"></a>cp15 协处理器初始化</h4><p>关闭MMU和cache。catch 是 cpu 内部的一个 2 级缓存，,她的作用是将常用的数据和指令放在 cpu 内部，关闭catch可使volatile无效，避免编译器对代码进行优化。uboot设置的寄存器都是物理地址，不需要虚拟地址，所以MMU可以关闭。</p>
<p>设置 TTB。TTB 就是 translation table base，转换表基地址。建立虚拟地址映射的主要工作就是建立这张转换表。转换表分为表索引和表项，表索引对应虚拟地址，表项对应物理地址。一对表索引和表项构成一个转换表单元，能够对一个内存块进行虚拟地址转换。转换表由若干个转换表单元构成的，每个单元负责 1 个内存块，总体的转换表负责整个内存空间的映射。</p>
<p>转换表放置在内存中，放置时要求起始地址在内存中要 x 位对齐。转换表不需要软件干涉，将基地址 TTB 设置到 cp15 的 c2 寄存器中，然后 MMU 工作时会自动去查转换表。</p>
<h4 id="复制-stage2-到-RAM"><a href="#复制-stage2-到-RAM" class="headerlink" title="复制 stage2 到 RAM"></a>复制 stage2 到 RAM</h4><p>拷贝 stage2 到 RAM时要确定两点：<br>-　stage2 的可执行镜像在固态存储设备的存放起始地址和终止地址；<br>-　RAM 空间的起始地址；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    ldr	r0, =_start</span><br><span class="line">    ldr	r1, =0x0</span><br><span class="line">    mov	r2, #16</span><br><span class="line">copyex:</span><br><span class="line">    subs	r2, r2, #1</span><br><span class="line">    ldr	r3, [r0], #4</span><br><span class="line">    str	r3, [r1], #4</span><br><span class="line">    bne	copyex</span><br></pre></td></tr></table></figure>

<h4 id="设置堆栈"><a href="#设置堆栈" class="headerlink" title="设置堆栈"></a>设置堆栈</h4><p>将 sp 指针指向一段没有被使用的内存就完成栈的设置。<br><img src="/images/uboot/uboot_mem.png" alt="1590311696418"></p>
<h4 id="清除-BSS-段"><a href="#清除-BSS-段" class="headerlink" title="清除 BSS 段"></a>清除 BSS 段</h4><p>BSS 段存放初始值为 0，未初始化的全局变量和静态变量，应该将这些变量的初始值赋为 0。</p>
<h4 id="跳转到-stage2-入口"><a href="#跳转到-stage2-入口" class="headerlink" title="跳转到 stage2 入口"></a>跳转到 stage2 入口</h4><h3 id="lowlevel-init-S"><a href="#lowlevel-init-S" class="headerlink" title="lowlevel_init.S"></a>lowlevel_init.S</h3><p>lowlevel_init 做一些开发板的初始化：检查复位状态、IO恢复、关看门狗、开发板供电锁存、时钟初始化、DDR初始化、串口初始化并打印’O’、tzpc初始化打印’K’。</p>
<h3 id="crt0-S"><a href="#crt0-S" class="headerlink" title="crt0.S"></a>crt0.S</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(_main)</span><br><span class="line">#if defined(CONFIG_SPL_BUILD) &amp;&amp; defined(CONFIG_SPL_STACK)</span><br><span class="line">    ldr	sp, =(CONFIG_SPL_STACK)</span><br><span class="line">#else</span><br><span class="line">    ldr	sp, =(CONFIG_SYS_INIT_SP_ADDR)</span><br><span class="line">#endif</span><br><span class="line">    bic	sp, sp, #7	/* 8-byte alignment for ABI compliance */</span><br><span class="line">    sub	sp, #GD_SIZE	/* allocate one GD above SP */</span><br><span class="line">    bic	sp, sp, #7	/* 8-byte alignment for ABI compliance */</span><br><span class="line">    mov	r9, sp		/* GD is above SP */</span><br><span class="line">    mov	r0, #0</span><br><span class="line">    bl	board_init_f</span><br></pre></td></tr></table></figure>

<p>设置sp栈指针，将栈地址8位对齐。sp减去全局变量的长度，就是给全局数据分配空间，再把sp的值传给r9，就是把gd全局变量放在r9寄存器中。栈空间紧靠在dg全局变量之上，然后调用 <a href="#board_init_f">board_init_f</a>函数。这个环境只有代码段，所以不包含变量，只包含只读常量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#if !defined(CONFIG_SPL_BUILD)</span><br><span class="line">    ldr	sp, [r9, #GD_START_ADDR_SP]	/* sp = gd-&gt;start_addr_sp */</span><br><span class="line">    bic	sp, sp, #7	/* 8-byte alignment for ABI compliance */</span><br><span class="line">    ldr	r9, [r9, #GD_BD]		/* r9 = gd-&gt;bd */</span><br><span class="line">    sub	r9, r9, #GD_SIZE		/* new GD is below bd */</span><br><span class="line"></span><br><span class="line">    adr	lr, here</span><br><span class="line">    ldr	r0, [r9, #GD_RELOC_OFF]		/* r0 = gd-&gt;reloc_off */</span><br><span class="line">    add	lr, lr, r0</span><br><span class="line">    ldr	r0, [r9, #GD_RELOCADDR]		/* r0 = gd-&gt;relocaddr */</span><br><span class="line">    b	relocate_code</span><br><span class="line">here:</span><br></pre></td></tr></table></figure>
<p>调用<a href="#relocate_code">relocate_code</a>重新定位uboot，对于SPL，不用重新定位。relocate_code 函数在 arch/arm/lib/<br>relocate.S 文件中定义。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    bl	c_runtime_cpu_setup	/* we still call old routine here */</span><br><span class="line"></span><br><span class="line">    ldr	r0, =__bss_start	/* this is auto-relocated! */</span><br><span class="line">    ldr	r1, =__bss_end		/* this is auto-relocated! */</span><br><span class="line"></span><br><span class="line">    mov	r2, #0x00000000		/* prepare zero to clear BSS */</span><br><span class="line"></span><br><span class="line">clbss_l:cmp	r0, r1			/* while not at end of BSS */</span><br><span class="line">    strlo	r2, [r0]		/* clear 32-bit BSS word */</span><br><span class="line">    addlo	r0, r0, #4		/* move to next */</span><br><span class="line">    blo	clbss_l</span><br><span class="line"></span><br><span class="line">    bl coloured_LED_init</span><br><span class="line">    bl red_led_on</span><br><span class="line"></span><br><span class="line">    /* call board_init_r(gd_t *id, ulong dest_addr) */</span><br><span class="line">    mov     r0, r9                  /* gd_t */</span><br><span class="line">    ldr	r1, [r9, #GD_RELOCADDR]	/* dest_addr */</span><br><span class="line">    /* call board_init_r */</span><br><span class="line">    ldr	pc, =board_init_r	/* this is auto-relocated! */</span><br><span class="line"></span><br><span class="line">ENDPROC(_main)</span><br></pre></td></tr></table></figure>
<p>调用<a href="#board_init_r">board_init_r</a>函数，这个环境包含BSS段和.data段。</p>
<h3 id="gd全局变量"><a href="#gd全局变量" class="headerlink" title="gd全局变量"></a>gd全局变量</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm-generic/global_data.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DECLARE_GLOBAL_DATA_PTR     register volatile gd_t *gd asm (<span class="string">&quot;r9&quot;</span>)  <span class="comment">//放到寄存器r9中</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __ASSEMBLY__</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">global_data</span> &#123;</span></span><br><span class="line">    <span class="type">bd_t</span> *bd;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> baudrate;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> cpu_clk;	<span class="comment">/* CPU clock in Hz!		*/</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> bus_clk;</span><br><span class="line">    <span class="comment">/* We cannot bracket this with CONFIG_PCI due to mpc5xxx */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> pci_clk;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> mem_clk;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_LCD) || defined(CONFIG_VIDEO)</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> fb_base;	<span class="comment">/* Base address of framebuffer mem */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_POST) || defined(CONFIG_LOGBUFFER)</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> post_log_word;  <span class="comment">/* Record POST activities */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> post_log_res; <span class="comment">/* success of POST test */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> post_init_f_time;  <span class="comment">/* When post_init_f started */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOARD_TYPES</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> board_type;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> have_console;	<span class="comment">/* serial_init() was called */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PRE_CONSOLE_BUFFER</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> precon_buf_idx;	<span class="comment">/* Pre-Console buffer index */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MODEM_SUPPORT</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> do_mdm_init;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> be_quiet;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> env_addr;	<span class="comment">/* Address  of Environment struct */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> env_valid;	<span class="comment">/* Checksum of Environment valid? */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> ram_top;	<span class="comment">/* Top address of RAM used by U-Boot */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> relocaddr;	<span class="comment">/* Start address of U-Boot in RAM */</span></span><br><span class="line">    <span class="type">phys_size_t</span> ram_size;	<span class="comment">/* RAM size */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> mon_len;	<span class="comment">/* monitor len */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> irq_sp;		<span class="comment">/* irq stack pointer */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> start_addr_sp;	<span class="comment">/* start_addr_stackpointer */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> reloc_off;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">global_data</span> *<span class="title">new_gd</span>;</span>	<span class="comment">/* relocated global data */</span></span><br><span class="line">    <span class="type">const</span> <span class="type">void</span> *fdt_blob;	<span class="comment">/* Our device tree, NULL if none */</span></span><br><span class="line">    <span class="type">void</span> *new_fdt;		<span class="comment">/* Relocated FDT */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> fdt_size;	<span class="comment">/* Space reserved for relocated FDT */</span></span><br><span class="line">    <span class="type">void</span> **jt;		<span class="comment">/* jump table */</span></span><br><span class="line">    <span class="type">char</span> env_buf[<span class="number">32</span>];	<span class="comment">/* buffer for getenv() before reloc. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_TRACE</span></span><br><span class="line">    <span class="type">void</span>		*trace_buff;	<span class="comment">/* The trace buffer */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SYS_I2C)</span></span><br><span class="line">    <span class="type">int</span>		cur_i2c_bus;	<span class="comment">/* current used i2c bus */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">arch_global_data</span> <span class="title">arch</span>;</span>	<span class="comment">/* architecture-specific data */</span></span><br><span class="line">&#125; <span class="type">gd_t</span>;</span><br></pre></td></tr></table></figure>

<p>gd 是一个指向gd_t类型的全局变量指针，地址是r9寄存器。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __ASSEMBLY__</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">bd_info</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>	bi_baudrate;	<span class="comment">/* serial console baudrate */</span></span><br><span class="line">    ulong	        bi_arch_number;	<span class="comment">/* unique id for this board */</span></span><br><span class="line">    ulong	        bi_boot_params;	<span class="comment">/* 向kernel传参的内存地址 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>	bi_arm_freq; <span class="comment">/* arm frequency */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>	bi_dsp_freq; <span class="comment">/* dsp core frequency */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>	bi_ddr_freq; <span class="comment">/* ddr frequency */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span>				/* <span class="title">RAM</span> <span class="title">configuration</span> */</span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    ulong start;</span><br><span class="line">    ulong size;</span><br><span class="line">    &#125;			bi_dram[CONFIG_NR_DRAM_BANKS];</span><br><span class="line">&#125; <span class="type">bd_t</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>bd_t 是开发板的板级信息的结构体， 包含硬件相关的参数，如波特率、IP 地址、机器码、DDR 内存分布。</p>
<ul>
<li><p>bi_arch_number 是开发板的机器码。就是 uboot 给这个开发板定义的一个唯一编号，主要作用是在 uboot 和 linux 内核之间进行比对和适配。</p>
</li>
<li><p>bi_boot_params  表示uboot给linux内核传参的内存地址，bootargs参数就是放在这里。</p>
</li>
</ul>
<h3 id="board-init-f"><a href="#board-init-f" class="headerlink" title="board_init_f"></a>board_init_f</h3><p>uboot 第二阶段代码的入口是 board_init_f 函数，是第一个在内存中运行的代码，在 arch/arm/lib/board.c 中定义。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">board_init_f</span><span class="params">(ulong bootflag)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">bd_t</span> *bd;</span><br><span class="line">    <span class="type">init_fnc_t</span> **init_fnc_ptr;</span><br><span class="line">    <span class="type">gd_t</span> *id;</span><br><span class="line">    ulong addr, addr_sp;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PRAM</span></span><br><span class="line">    ulong reg;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">void</span> *new_fdt = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> fdt_size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>((<span class="type">void</span> *)gd, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="type">gd_t</span>));</span><br><span class="line"></span><br><span class="line">    gd-&gt;mon_len = _bss_end_ofs;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_OF_EMBED</span></span><br><span class="line">    <span class="comment">/* Get a pointer to the FDT */</span></span><br><span class="line">    gd-&gt;fdt_blob = _binary_dt_dtb_start;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined CONFIG_OF_SEPARATE</span></span><br><span class="line">    <span class="comment">/* FDT is at end of image */</span></span><br><span class="line">    gd-&gt;fdt_blob = (<span class="type">void</span> *)(_end_ofs + _TEXT_BASE);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* Allow the early environment to override the fdt address */</span></span><br><span class="line">    gd-&gt;fdt_blob = (<span class="type">void</span> *)getenv_ulong(<span class="string">&quot;fdtcontroladdr&quot;</span>, <span class="number">16</span>,</span><br><span class="line">                        (<span class="type">uintptr_t</span>)gd-&gt;fdt_blob);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (init_fnc_ptr = init_sequence; *init_fnc_ptr; ++init_fnc_ptr) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*init_fnc_ptr)() != <span class="number">0</span>) &#123;</span><br><span class="line">            hang ();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_OF_CONTROL</span></span><br><span class="line">    <span class="comment">/* For now, put this check after the console is ready */</span></span><br><span class="line">    <span class="keyword">if</span> (fdtdec_prepare_fdt()) &#123;</span><br><span class="line">        panic(<span class="string">&quot;** CONFIG_OF_CONTROL defined but no FDT - please see &quot;</span></span><br><span class="line">            <span class="string">&quot;doc/README.fdt-control&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SYS_MEM_TOP_HIDE)</span></span><br><span class="line">    gd-&gt;ram_size -= CONFIG_SYS_MEM_TOP_HIDE;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    addr = CONFIG_SYS_SDRAM_BASE + gd-&gt;ram_size;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_LOGBUFFER</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_ALT_LB_ADDR</span></span><br><span class="line">    <span class="comment">/* reserve kernel log buffer */</span></span><br><span class="line">    addr -= (LOGBUFF_RESERVE);</span><br><span class="line">    debug(<span class="string">&quot;Reserving %dk for kernel logbuffer at %08lx\n&quot;</span>, LOGBUFF_LEN,</span><br><span class="line">        addr);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PRAM</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * reserve protected RAM</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    reg = getenv_ulong(<span class="string">&quot;pram&quot;</span>, <span class="number">10</span>, CONFIG_PRAM);</span><br><span class="line">    addr -= (reg &lt;&lt; <span class="number">10</span>);		<span class="comment">/* size is in kB */</span></span><br><span class="line">    debug(<span class="string">&quot;Reserving %ldk for protected RAM at %08lx\n&quot;</span>, reg, addr);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_PRAM */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !(defined(CONFIG_SYS_ICACHE_OFF) &amp;&amp; defined(CONFIG_SYS_DCACHE_OFF))</span></span><br><span class="line">    <span class="comment">/* reserve TLB table */</span></span><br><span class="line">    gd-&gt;arch.tlb_size = <span class="number">4096</span> * <span class="number">4</span>;</span><br><span class="line">    addr -= gd-&gt;arch.tlb_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* round down to next 64 kB limit */</span></span><br><span class="line">    addr &amp;= ~(<span class="number">0x10000</span> - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    gd-&gt;arch.tlb_addr = addr;</span><br><span class="line">    debug(<span class="string">&quot;TLB table from %08lx to %08lx\n&quot;</span>, addr, addr + gd-&gt;arch.tlb_size);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* round down to next 4 kB limit */</span></span><br><span class="line">    addr &amp;= ~(<span class="number">4096</span> - <span class="number">1</span>);</span><br><span class="line">    debug(<span class="string">&quot;Top of RAM usable for U-Boot at: %08lx\n&quot;</span>, addr);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_LCD</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FB_ADDR</span></span><br><span class="line">    gd-&gt;fb_base = CONFIG_FB_ADDR;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="comment">/* reserve memory for LCD display (always full pages) */</span></span><br><span class="line">    addr = lcd_setmem(addr);</span><br><span class="line">    gd-&gt;fb_base = addr;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_FB_ADDR */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_LCD */</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * reserve memory for U-Boot code, data &amp; bss</span></span><br><span class="line"><span class="comment">     * round down to next 4 kB limit</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    addr -= gd-&gt;mon_len;</span><br><span class="line">    addr &amp;= ~(<span class="number">4096</span> - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    debug(<span class="string">&quot;Reserving %ldk for U-Boot at: %08lx\n&quot;</span>, gd-&gt;mon_len &gt;&gt; <span class="number">10</span>, addr);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_SPL_BUILD</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * reserve memory for malloc() arena</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    addr_sp = addr - TOTAL_MALLOC_LEN;</span><br><span class="line">    debug(<span class="string">&quot;Reserving %dk for malloc() at: %08lx\n&quot;</span>,</span><br><span class="line">            TOTAL_MALLOC_LEN &gt;&gt; <span class="number">10</span>, addr_sp);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * (permanently) allocate a Board Info struct</span></span><br><span class="line"><span class="comment">     * and a permanent copy of the &quot;global&quot; data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    addr_sp -= <span class="keyword">sizeof</span> (<span class="type">bd_t</span>);</span><br><span class="line">    bd = (<span class="type">bd_t</span> *) addr_sp;</span><br><span class="line">    gd-&gt;bd = bd;</span><br><span class="line">    debug(<span class="string">&quot;Reserving %zu Bytes for Board Info at: %08lx\n&quot;</span>,</span><br><span class="line">            <span class="keyword">sizeof</span> (<span class="type">bd_t</span>), addr_sp);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MACH_TYPE</span></span><br><span class="line">    gd-&gt;bd-&gt;bi_arch_number = CONFIG_MACH_TYPE; <span class="comment">/* board id for Linux */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    addr_sp -= <span class="keyword">sizeof</span> (<span class="type">gd_t</span>);</span><br><span class="line">    id = (<span class="type">gd_t</span> *) addr_sp;</span><br><span class="line">    debug(<span class="string">&quot;Reserving %zu Bytes for Global Data at: %08lx\n&quot;</span>,</span><br><span class="line">            <span class="keyword">sizeof</span> (<span class="type">gd_t</span>), addr_sp);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_OF_SEPARATE) &amp;&amp; defined(CONFIG_OF_CONTROL)</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If the device tree is sitting immediate above our image then we</span></span><br><span class="line"><span class="comment">     * must relocate it. If it is embedded in the data section, then it</span></span><br><span class="line"><span class="comment">     * will be relocated with other data.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (gd-&gt;fdt_blob) &#123;</span><br><span class="line">        fdt_size = ALIGN(fdt_totalsize(gd-&gt;fdt_blob) + <span class="number">0x1000</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">        addr_sp -= fdt_size;</span><br><span class="line">        new_fdt = (<span class="type">void</span> *)addr_sp;</span><br><span class="line">        debug(<span class="string">&quot;Reserving %zu Bytes for FDT at: %08lx\n&quot;</span>,</span><br><span class="line">              fdt_size, addr_sp);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* setup stackpointer for exeptions */</span></span><br><span class="line">    gd-&gt;irq_sp = addr_sp;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_USE_IRQ</span></span><br><span class="line">    addr_sp -= (CONFIG_STACKSIZE_IRQ+CONFIG_STACKSIZE_FIQ);</span><br><span class="line">    debug(<span class="string">&quot;Reserving %zu Bytes for IRQ stack at: %08lx\n&quot;</span>,</span><br><span class="line">        CONFIG_STACKSIZE_IRQ+CONFIG_STACKSIZE_FIQ, addr_sp);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">/* leave 3 words for abort-stack    */</span></span><br><span class="line">    addr_sp -= <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 8-byte alignment for ABI compliance */</span></span><br><span class="line">    addr_sp &amp;= ~<span class="number">0x07</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    addr_sp += <span class="number">128</span>;	<span class="comment">/* leave 32 words for abort-stack   */</span></span><br><span class="line">    gd-&gt;irq_sp = addr_sp;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    interrupt_init();</span><br><span class="line"></span><br><span class="line">    debug(<span class="string">&quot;New Stack Pointer is: %08lx\n&quot;</span>, addr_sp);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_POST</span></span><br><span class="line">    post_bootmode_init();</span><br><span class="line">    post_run(<span class="literal">NULL</span>, POST_ROM | post_bootmode_get(<span class="number">0</span>));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    gd-&gt;bd-&gt;bi_baudrate = gd-&gt;baudrate;</span><br><span class="line">    <span class="comment">/* Ram ist board specific, so move it to board code ... */</span></span><br><span class="line">    dram_init_banksize();</span><br><span class="line">    display_dram_config();	<span class="comment">/* and display it */</span></span><br><span class="line"></span><br><span class="line">    gd-&gt;relocaddr = addr;</span><br><span class="line">    gd-&gt;start_addr_sp = addr_sp;</span><br><span class="line">    gd-&gt;reloc_off = addr - _TEXT_BASE;</span><br><span class="line">    debug(<span class="string">&quot;relocation Offset is: %08lx\n&quot;</span>, gd-&gt;reloc_off);</span><br><span class="line">    <span class="keyword">if</span> (new_fdt) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(new_fdt, gd-&gt;fdt_blob, fdt_size);</span><br><span class="line">        gd-&gt;fdt_blob = new_fdt;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(id, (<span class="type">void</span> *)gd, <span class="keyword">sizeof</span>(<span class="type">gd_t</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要是填充 gd、bd数据，设置堆、栈。</p>
<h3 id="relocate"><a href="#relocate" class="headerlink" title="relocate"></a>relocate</h3><h3 id="board-init-r"><a href="#board-init-r" class="headerlink" title="board_init_r"></a>board_init_r</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">board_init_r</span><span class="params">(<span class="type">gd_t</span> *id, ulong dest_addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    ulong malloc_start;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_SYS_NO_FLASH)</span></span><br><span class="line">    ulong flash_size;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    gd-&gt;flags |= GD_FLG_RELOC;	<span class="comment">/* tell others: relocation done */</span></span><br><span class="line">    bootstage_mark_name(BOOTSTAGE_ID_START_UBOOT_R, <span class="string">&quot;board_init_r&quot;</span>);</span><br><span class="line"></span><br><span class="line">    monitor_flash_len = _end_ofs;</span><br><span class="line"></span><br><span class="line">    enable_caches();</span><br><span class="line"></span><br><span class="line">    board_init();	<span class="comment">/* Setup chipselects */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CLOCKS</span></span><br><span class="line">    set_cpu_clk_info(); <span class="comment">/* Setup clock information */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    serial_initialize();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_LOGBUFFER</span></span><br><span class="line">    logbuff_init_ptrs();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_POST</span></span><br><span class="line">    post_output_backlog();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The Malloc area is immediately below the monitor copy in DRAM */</span></span><br><span class="line">    malloc_start = dest_addr - TOTAL_MALLOC_LEN;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*初始化uboot的堆管理器*/</span></span><br><span class="line">    mem_malloc_init (malloc_start, TOTAL_MALLOC_LEN);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ARCH_EARLY_INIT_R</span></span><br><span class="line">    arch_early_init_r();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    power_init_board();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_SYS_NO_FLASH)</span></span><br><span class="line"></span><br><span class="line">    flash_size = flash_init();</span><br><span class="line">    <span class="keyword">if</span> (flash_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta"># <span class="keyword">ifdef</span> CONFIG_SYS_FLASH_CHECKSUM</span></span><br><span class="line">        print_size(flash_size, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getenv_yesno(<span class="string">&quot;flashchecksum&quot;</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;  CRC: %08X&quot;</span>, crc32(<span class="number">0</span>,</span><br><span class="line">                (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *) CONFIG_SYS_FLASH_BASE,</span><br><span class="line">                flash_size));</span><br><span class="line">        &#125;</span><br><span class="line">        putc(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line"><span class="meta"># <span class="keyword">else</span>	<span class="comment">/* !CONFIG_SYS_FLASH_CHECKSUM */</span></span></span><br><span class="line">        print_size(flash_size, <span class="string">&quot;\n&quot;</span>);</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span> <span class="comment">/* CONFIG_SYS_FLASH_CHECKSUM */</span></span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">puts</span>(failed);</span><br><span class="line">        hang();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CMD_NAND)</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;NAND:  &quot;</span>);</span><br><span class="line">    nand_init();		<span class="comment">/* go init the NAND */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CMD_ONENAND)</span></span><br><span class="line">    onenand_init();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_GENERIC_MMC</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;MMC:   &quot;</span>);</span><br><span class="line">    mmc_initialize(gd-&gt;bd);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HAS_DATAFLASH</span></span><br><span class="line">    AT91F_DataflashInit();</span><br><span class="line">    dataflash_print_info();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* initialize environment */</span></span><br><span class="line">    <span class="keyword">if</span> (should_load_env())</span><br><span class="line">        env_relocate();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        set_default_env(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CMD_PCI) || defined(CONFIG_PCI)</span></span><br><span class="line">    arm_pci_init();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    stdio_init();	<span class="comment">/* get the devices list going. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*建立一个函数跳转表*/</span></span><br><span class="line">    jumptable_init();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_API)</span></span><br><span class="line">    <span class="comment">/* Initialize API */</span></span><br><span class="line">    api_init();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    console_init_r();	<span class="comment">/* fully init console as a device */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DISPLAY_BOARDINFO_LATE</span></span><br><span class="line"><span class="meta"># <span class="keyword">ifdef</span> CONFIG_OF_CONTROL</span></span><br><span class="line">    <span class="comment">/* Put this here so it appears on the LCD, now it is ready */</span></span><br><span class="line">    display_fdt_model(gd-&gt;fdt_blob);</span><br><span class="line"><span class="meta"># <span class="keyword">else</span></span></span><br><span class="line">    checkboard();</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_ARCH_MISC_INIT)</span></span><br><span class="line">    <span class="comment">/* miscellaneous arch dependent initialisations */</span></span><br><span class="line">    arch_misc_init();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_MISC_INIT_R)</span></span><br><span class="line">    <span class="comment">/* miscellaneous platform dependent initialisations */</span></span><br><span class="line">    misc_init_r();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* enable exceptions */</span></span><br><span class="line">    enable_interrupts();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize from environment */</span></span><br><span class="line">    load_addr = getenv_ulong(<span class="string">&quot;loadaddr&quot;</span>, <span class="number">16</span>, load_addr);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BOARD_LATE_INIT</span></span><br><span class="line">    board_late_init();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_BITBANGMII</span></span><br><span class="line">    bb_miiphy_init();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CMD_NET)</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Net:   &quot;</span>);</span><br><span class="line">    eth_initialize(gd-&gt;bd);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_RESET_PHY_R)</span></span><br><span class="line">    reset_phy();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_POST</span></span><br><span class="line">    post_run(<span class="literal">NULL</span>, POST_RAM | post_bootmode_get(<span class="number">0</span>));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PRAM) || defined(CONFIG_LOGBUFFER)</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Export available size of memory for Linux,</span></span><br><span class="line"><span class="comment">     * taking into account the protected RAM at top of memory</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &#123;</span><br><span class="line">        ulong pram = <span class="number">0</span>;</span><br><span class="line">        uchar memsz[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PRAM</span></span><br><span class="line">        pram = getenv_ulong(<span class="string">&quot;pram&quot;</span>, <span class="number">10</span>, CONFIG_PRAM);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_LOGBUFFER</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_ALT_LB_ADDR</span></span><br><span class="line">        <span class="comment">/* Also take the logbuffer into account (pram is in kB) */</span></span><br><span class="line">        pram += (LOGBUFF_LEN + LOGBUFF_OVERHEAD) / <span class="number">1024</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="built_in">sprintf</span>((<span class="type">char</span> *)memsz, <span class="string">&quot;%ldk&quot;</span>, (gd-&gt;ram_size / <span class="number">1024</span>) - pram);</span><br><span class="line">        setenv(<span class="string">&quot;mem&quot;</span>, (<span class="type">char</span> *)memsz);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        main_loop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行串口、flash、网卡、控制台等初始化，最后进入 main_loop()函数中。board_init()是开发板相关的初始化，在/board/samsung/xxx/xxx.c中定义。</p>
<h3 id="main-loop"><a href="#main-loop" class="headerlink" title="main_loop"></a>main_loop</h3><p>main_loop()函数在common/main.c文件定义，等待终端输入命令以及对命令进行处理。</p>
<h2 id="启动内核"><a href="#启动内核" class="headerlink" title="启动内核"></a>启动内核</h2><h3 id="mkimage"><a href="#mkimage" class="headerlink" title="mkimage"></a>mkimage</h3><p>内核编译成功会生成 vmlinux、Image、zImage，再通过 uboot 提供的工具 mkimage，执行``make uImage` 命令生成 uImage。</p>
<ul>
<li><strong>vmlinux</strong>  原始的未经任何处理加工的原版内核 elf 文件，一般PC机上直接加载就可运行。</li>
<li><strong>Image</strong>  由vmlinux 经 objcopy 去掉一些不需要的东西之后得到。</li>
<li><strong>zImage</strong>  由Image用gzip压缩得到，文件开头嵌有解压缩代码。</li>
<li><strong>uImage</strong>   uboot专用的镜像文件，它是在zImage之前加上64字节的头部信息合成，说明这个内核的版本、加载位置、生成时间、大小等信息；其0x40之后与zImage没区别。</li>
</ul>
<p><img src="/images/uboot/vmlinux.bmp" alt="img"></p>
<p>uboot都支持uImage启动，支持zImage启动需要定义LINUX_ZIMAGE_MAGIC宏。</p>
<p>mkimage工具在uboot源代码的tools/目录下，用来给zImage镜像添加64字节的头部信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">参数说明：</span><br><span class="line"></span><br><span class="line">-A：指定 CPU 的体系结构，alpha、arm 、x86、ia64、mips、mips64、 ppc 、s390、sh、sparc 、sparc64、m68k 等；</span><br><span class="line">-O：指定操作系统类型，可用值有：openbsd、netbsd、freebsd、4_4bsd、linux、 svr4、esix、solaris、irix、sco、dell、ncr、lynxos、vxworks、psos、qnx、u-boot、rtems、artos；</span><br><span class="line">-T：指定镜像类型，可用值有：standalone、kernel、ramdisk、multi、firmware、script、filesystem；</span><br><span class="line">-C：指定镜像压缩方式，可用值有：</span><br><span class="line">    ：none 不压缩(一般使用这个，因为 zImage 是已经被 bzip2 压缩过的自解压内核)；</span><br><span class="line">    ：zip 用 gzip 的压缩方式；</span><br><span class="line">    ：bzip2 用 bzip2 的压缩方式；</span><br><span class="line">-a：指定镜像在内存中的加载地址，镜像下载到内存中时，要按照这个地址来下载；</span><br><span class="line">-e：指定镜像运行的入口点地址，这个地址就是-a 参数指定的值加上0x40（前面mkimage添加了64个字节头）；</span><br><span class="line">-n：指定镜像名；</span><br><span class="line">-d：指定制作镜像的源文件；</span><br></pre></td></tr></table></figure>

<p>uboot启动内核的打印：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Booting kernel from Legacy Image at 82208000 ...</span><br><span class="line">Image Name:   Linux-3.4.35</span><br><span class="line">Image Type:   ARM Linux Kernel Image (uncompressed)</span><br><span class="line">Data Size:    1417696 Bytes = 1.4 MiB</span><br><span class="line">Load Address: 82208000</span><br><span class="line">Entry Point:  82208040</span><br><span class="line">Verifying Checksum ... OK</span><br><span class="line">XIP Kernel Image ... OK</span><br></pre></td></tr></table></figure>

<h3 id="加载内核到DDR"><a href="#加载内核到DDR" class="headerlink" title="加载内核到DDR"></a>加载内核到DDR</h3><p>uboot将内核镜像从启动介质中加载到DDR中，还要给内核传递启动参数，内核就从链接地址处开始运行。</p>
<h3 id="校验内核格式"><a href="#校验内核格式" class="headerlink" title="校验内核格式"></a>校验内核格式</h3><p>uboot用bootm命令引导内核，bootm会读取一个64字节的文件头，来获取这个内核镜像所针对的CPU体系结构、OS、加载到内存中的位置、在内存中入口点的位置以及镜像名等等信息。这样bootm才能为OS设置好启动环境，并跳入内核镜像的入口点。</p>
<p>当bootm命令执行时，uboot实际执行do_bootm()函数，在cmd_bootm.c中定义。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">do_bootm</span><span class="params">(<span class="type">cmd_tbl_t</span> *cmdtp, <span class="type">int</span> flag, <span class="type">int</span> argc, <span class="type">char</span> * <span class="type">const</span> argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NEEDS_MANUAL_RELOC</span></span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> relocated = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!relocated) &#123;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* relocate boot function table */</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(boot_os); i++)</span><br><span class="line">            <span class="keyword">if</span> (boot_os[i] != <span class="literal">NULL</span>)</span><br><span class="line">                boot_os[i] += gd-&gt;reloc_off;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* relocate names of sub-command table */</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(cmd_bootm_sub); i++)</span><br><span class="line">            cmd_bootm_sub[i].name += gd-&gt;reloc_off;</span><br><span class="line"></span><br><span class="line">        relocated = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* determine if we have a sub command */</span></span><br><span class="line">    argc--; argv++;</span><br><span class="line">    <span class="keyword">if</span> (argc &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">char</span> *endp;</span><br><span class="line"></span><br><span class="line">        simple_strtoul(argv[<span class="number">0</span>], &amp;endp, <span class="number">16</span>);</span><br><span class="line">        <span class="comment">/* endp pointing to NULL means that argv[0] was just a</span></span><br><span class="line"><span class="comment">         * valid number, pass it along to the normal bootm processing</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * If endp is &#x27;:&#x27; or &#x27;#&#x27; assume a FIT identifier so pass</span></span><br><span class="line"><span class="comment">         * along for normal processing.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Right now we assume the first arg should never be &#x27;-&#x27;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> ((*endp != <span class="number">0</span>) &amp;&amp; (*endp != <span class="string">&#x27;:&#x27;</span>) &amp;&amp; (*endp != <span class="string">&#x27;#&#x27;</span>))</span><br><span class="line">            <span class="keyword">return</span> do_bootm_subcommand(cmdtp, flag, argc, argv);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> do_bootm_states(cmdtp, flag, argc, argv, BOOTM_STATE_START |</span><br><span class="line">        BOOTM_STATE_FINDOS | BOOTM_STATE_FINDOTHER |</span><br><span class="line">        BOOTM_STATE_LOADOS |</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_PPC) || defined(CONFIG_MIPS)</span></span><br><span class="line">        BOOTM_STATE_OS_CMDLINE |</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        BOOTM_STATE_OS_PREP | BOOTM_STATE_OS_FAKE_GO |</span><br><span class="line">        BOOTM_STATE_OS_GO, &amp;images, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="命令体系"><a href="#命令体系" class="headerlink" title="命令体系"></a>命令体系</h2><h2 id="uboot命令"><a href="#uboot命令" class="headerlink" title="uboot命令"></a>uboot命令</h2><h3 id="变量管理"><a href="#变量管理" class="headerlink" title="变量管理"></a>变量管理</h3><p><strong>printenv/print</strong>  打印出系统中所有的环境变量。</p>
<p><strong>setenv/set</strong>  设置（添加/更改）环境变量，变量名后面没参数就是删除该环境变量。</p>
<p><strong>saveenv/save</strong>  保存环境变量的更改到flash分区。</p>
<h3 id="内存操作"><a href="#内存操作" class="headerlink" title="内存操作"></a>内存操作</h3><h3 id="flash操作"><a href="#flash操作" class="headerlink" title="flash操作"></a>flash操作</h3><h4 id="sf"><a href="#sf" class="headerlink" title="sf"></a>sf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sf probe [[bus:]cs] [hz] [mode]  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">init flash device on given SPI bus and chip select</span></span><br><span class="line"></span><br><span class="line">sf read addr offset len    </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">read</span> `len<span class="string">&#x27; bytes starting at`offset&#x27;</span> to memory at `addr<span class="string">&#x27;</span></span></span><br><span class="line"></span><br><span class="line">sf write addr offset len  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">write `len&#x27;</span> bytes from memor at `addr<span class="string">&#x27; to flash at `offset&#x27;</span></span></span><br><span class="line"></span><br><span class="line">sf erase offset [+]len   </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">erase `len<span class="string">&#x27; bytes from `offset&#x27;</span> `+len<span class="string">&#x27; round up `len&#x27;</span> to block size</span></span><br><span class="line"></span><br><span class="line">sf update addr offset len  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">erase and write `len<span class="string">&#x27; bytes from memory at `addr&#x27;</span> to flash at `offset<span class="string">&#x27;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="tftp"><a href="#tftp" class="headerlink" title="tftp"></a>tftp</h3><h2 id="uboot移植"><a href="#uboot移植" class="headerlink" title="uboot移植"></a>uboot移植</h2><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45544223/category_9907716.html">https://blog.csdn.net/qq_45544223/category_9907716.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Cqlismy/category/1603479.html">https://www.cnblogs.com/Cqlismy/category/1603479.html</a></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/09/04/hardware/RF/" rel="prev" title="无线电">
      <i class="fa fa-chevron-left"></i> 无线电
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/09/04/tool/vim/" rel="next" title="vim插件与配置">
      vim插件与配置 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Boot-Loader"><span class="nav-number">1.</span> <span class="nav-text">Boot Loader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-number">2.</span> <span class="nav-text">目录结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="nav-number">3.</span> <span class="nav-text">编译与配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Makefile-%E5%88%86%E6%9E%90"><span class="nav-number">3.1.</span> <span class="nav-text">Makefile 分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mkconfig-%E5%88%86%E6%9E%90"><span class="nav-number">3.2.</span> <span class="nav-text">mkconfig 分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#u-boot-lds"><span class="nav-number">3.3.</span> <span class="nav-text">u-boot.lds</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-number">4.</span> <span class="nav-text">启动流程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#start-S"><span class="nav-number">4.1.</span> <span class="nav-text">start.S</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E5%BC%82%E5%B8%B8%E5%90%91%E9%87%8F%E8%A1%A8"><span class="nav-number">4.1.1.</span> <span class="nav-text">设置异常向量表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E4%BB%A3%E7%A0%81%E6%AE%B5%E7%9A%84%E7%BC%96%E8%AF%91%E5%9C%B0%E5%9D%80"><span class="nav-number">4.1.2.</span> <span class="nav-text">指定代码段的编译地址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#reset%E5%A4%8D%E4%BD%8D"><span class="nav-number">4.1.3.</span> <span class="nav-text">reset复位</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cp15-%E5%8D%8F%E5%A4%84%E7%90%86%E5%99%A8%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">4.1.4.</span> <span class="nav-text">cp15 协处理器初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%8D%E5%88%B6-stage2-%E5%88%B0-RAM"><span class="nav-number">4.1.5.</span> <span class="nav-text">复制 stage2 到 RAM</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E5%A0%86%E6%A0%88"><span class="nav-number">4.1.6.</span> <span class="nav-text">设置堆栈</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B8%85%E9%99%A4-BSS-%E6%AE%B5"><span class="nav-number">4.1.7.</span> <span class="nav-text">清除 BSS 段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%B3%E8%BD%AC%E5%88%B0-stage2-%E5%85%A5%E5%8F%A3"><span class="nav-number">4.1.8.</span> <span class="nav-text">跳转到 stage2 入口</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lowlevel-init-S"><span class="nav-number">4.2.</span> <span class="nav-text">lowlevel_init.S</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#crt0-S"><span class="nav-number">4.3.</span> <span class="nav-text">crt0.S</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gd%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="nav-number">4.4.</span> <span class="nav-text">gd全局变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#board-init-f"><span class="nav-number">4.5.</span> <span class="nav-text">board_init_f</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#relocate"><span class="nav-number">4.6.</span> <span class="nav-text">relocate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#board-init-r"><span class="nav-number">4.7.</span> <span class="nav-text">board_init_r</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#main-loop"><span class="nav-number">4.8.</span> <span class="nav-text">main_loop</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8"><span class="nav-number">5.</span> <span class="nav-text">启动内核</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#mkimage"><span class="nav-number">5.1.</span> <span class="nav-text">mkimage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E5%86%85%E6%A0%B8%E5%88%B0DDR"><span class="nav-number">5.2.</span> <span class="nav-text">加载内核到DDR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%A1%E9%AA%8C%E5%86%85%E6%A0%B8%E6%A0%BC%E5%BC%8F"><span class="nav-number">5.3.</span> <span class="nav-text">校验内核格式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E4%BD%93%E7%B3%BB"><span class="nav-number">6.</span> <span class="nav-text">命令体系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#uboot%E5%91%BD%E4%BB%A4"><span class="nav-number">7.</span> <span class="nav-text">uboot命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E7%AE%A1%E7%90%86"><span class="nav-number">7.1.</span> <span class="nav-text">变量管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E6%93%8D%E4%BD%9C"><span class="nav-number">7.2.</span> <span class="nav-text">内存操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flash%E6%93%8D%E4%BD%9C"><span class="nav-number">7.3.</span> <span class="nav-text">flash操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sf"><span class="nav-number">7.3.1.</span> <span class="nav-text">sf</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tftp"><span class="nav-number">7.4.</span> <span class="nav-text">tftp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#uboot%E7%A7%BB%E6%A4%8D"><span class="nav-number">8.</span> <span class="nav-text">uboot移植</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">9.</span> <span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ubun2</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">221</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ubun2</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v5.4.2
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.7.2
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
